name: Build Windows EXE (CMake + MSVC)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install numpy matplotlib

      - name: Clone matplotlib-cpp
        run: git clone https://github.com/lava/matplotlib-cpp.git

      - name: Ensure CMakeLists.txt exists
        run: |
          if not exist CMakeLists.txt (
            echo cmake_minimum_required(VERSION 3.14) > CMakeLists.txt
            echo project(LancerDePoids LANGUAGES CXX) >> CMakeLists.txt
            echo find_package(Python3 COMPONENTS Interpreter Development NumPy REQUIRED) >> CMakeLists.txt
            echo include_directories($${Python3_INCLUDE_DIRS}) >> CMakeLists.txt
            echo include_directories($${Python3_NumPy_INCLUDE_DIRS}) >> CMakeLists.txt
            echo include_directories(matplotlib-cpp) >> CMakeLists.txt
            echo add_executable(LancerDePoids LancerDePoids.cpp) >> CMakeLists.txt
            echo target_link_libraries(LancerDePoids $${Python3_LIBRARIES}) >> CMakeLists.txt
          )

      - name: Configure and Build with CMake
        run: |
          mkdir build
          cd build

          for /f "usebackq delims=" %%i in (`python -c "import sys; print(sys.executable)"`) do set PY_EXE=%%i
          for /f "usebackq delims=" %%i in (`python -c "import sysconfig; print(sysconfig.get_paths()['include'])"`) do set PY_INC=%%i
          for /f "usebackq delims=" %%i in (`python -c "import numpy; print(numpy.get_include())"`) do set NP_INC=%%i

          cmake .. -G "Visual Studio 17 2022" -A x64 ^
            -DPython3_EXECUTABLE="%PY_EXE%" ^
            -DPython3_INCLUDE_DIR="%PY_INC%" ^
            -DPython3_NumPy_INCLUDE_DIR="%NP_INC%"

          cmake --build . --config Release

          if exist Release\LancerDePoids.exe (
            copy Release\LancerDePoids.exe ..\LancerDePoids.exe
          )
          cd ..

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: LancerDePoids.exe
          path: LancerDePoids.exe
